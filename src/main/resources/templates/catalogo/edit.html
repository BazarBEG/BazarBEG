<html lang="es"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="/layouts/_mainLayoutAdmin.html">

<div layout:fragment="content" class="p-6">

  <h1 class="text-2xl font-bold text-gray-800 mb-4">Editar Catálogo</h1>

  <form th:action="@{/catalogos/update/{id}(id=${catalogo.id})}" th:object="${catalogo}" method="post" enctype="multipart/form-data" class="space-y-4">

    <div>
      <label for="nombre" class="block text-sm font-medium text-gray-700">Título</label>
      <input type="text" th:field="*{nombre}" id="nombre"
             class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm" required>
    </div>

    <div>
      <label for="descripcion" class="block text-sm font-medium text-gray-700">Descripción</label>
      <textarea th:field="*{descripcion}" id="descripcion"
                class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm" rows="3" required></textarea>
    </div>

    <div class="grid grid-cols-2 gap-4">
      <div>
        <label for="fechaInicio" class="block text-sm font-medium text-gray-700">Fecha de inicio</label>
        <input type="date" th:field="*{fechaInicio}" id="fechaInicio"
               class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm" required>
      </div>
      <div>
        <label for="fechaFin" class="block text-sm font-medium text-gray-700">Fecha de finalización</label>
        <input type="date" th:field="*{fechaFin}" id="fechaFin"
               class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm" required>
      </div>
    </div>

    <div>
      <label for="categoria" class="block text-sm font-medium text-gray-700">Categoría</label>
      <select id="categoria" th:field="*{categoria.id}" required
              class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm">
        <option value="" disabled>Selecciona una categoría</option>
        <option th:each="cat : ${categorias}"
                th:value="${cat.id}"
                th:text="${cat.nombre}"
                th:selected="${catalogo.categoria != null and catalogo.categoria.id == cat.id}">
        </option>
      </select>
    </div>

    <div>
      <label class="block font-medium">Productos:</label>
      <div id="productos-container" class="mt-1 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 border p-4 rounded-md">
      </div>
    </div>

    <div>
      <label for="portadaFile" class="block text-sm font-medium text-gray-700">Portada</label>
      <input type="file" name="portadaFile" id="portadaFile" class="mt-1 block w-full text-sm text-gray-500">
      <div th:if="${catalogo.portadaImagen != null}" class="mt-2">
        <img th:src="@{${catalogo.portadaImagen}}" alt="Portada" class="w-32 h-auto rounded-md">
      </div>
    </div>

    <div th:if="${catalogo.pdfPath != null}" class="mt-2">
      <a th:href="@{${catalogo.pdfPath}}" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-md hover:bg-gray-300" target="_blank">
        Vista Previa PDF
      </a>
    </div>

    <div class="flex space-x-4 mt-4">
      <button type="submit" class="px-4 py-2 bg-purple-600 text-white rounded-md hover:bg-purple-700">Actualizar</button>
      <a th:href="@{/catalogos}" class="px-4 py-2 bg-gray-300 text-gray-700 rounded-md hover:bg-gray-400">Cancelar</a>
    </div>

  </form>
</div>
<script th:inline="javascript">
  document.addEventListener('DOMContentLoaded', function() {
      const categoriaSelect = document.getElementById('categoria');
      const productosContainer = document.getElementById('productos-container');

      // Obtener los IDs de los productos ya seleccionados del modelo del controlador.
      // Esta lista ya está en el formato correcto para JavaScript.
      const productosIdsSeleccionados = [[${productosIdsSeleccionados}]];

      // Función para renderizar los productos y preseleccionar los checkboxes
      const renderProductos = function(productos) {
          productosContainer.innerHTML = '';
          if (productos.length === 0) {
              productosContainer.innerHTML = '<p class="text-gray-500">No hay productos disponibles para esta categoría.</p>';
              return;
          }

          productos.forEach(p => {
              const itemDiv = document.createElement('div');
              itemDiv.className = 'border p-3 rounded-lg shadow-sm flex items-center gap-4';

              const img = document.createElement('img');
              img.src = p.imagen;
              img.alt = p.nombre;
              img.className = 'w-16 h-16 object-cover rounded-md';

              const infoDiv = document.createElement('div');
              infoDiv.innerHTML = `<h4 class="font-bold">${p.nombre}</h4><p class="text-sm text-gray-600">$${p.precio}</p>`;

              const checkbox = document.createElement('input');
              checkbox.type = 'checkbox';
              checkbox.name = 'productosIds';
              checkbox.value = p.id;
              checkbox.className = 'form-checkbox h-5 w-5 text-purple-600';

              if (productosIdsSeleccionados.includes(p.id)) {
                  checkbox.checked = true;
              }

              itemDiv.appendChild(img);
              itemDiv.appendChild(infoDiv);
              itemDiv.appendChild(checkbox);
              productosContainer.appendChild(itemDiv);
          });
      };

      // Si la categoría tiene un valor inicial, carga los productos
      if (categoriaSelect.value) {
          fetch(`/catalogos/productosPorCategoria/${categoriaSelect.value}`)
              .then(resp => resp.json())
              .then(data => {
                  renderProductos(data);
              });
      }

      // Si la categoría cambia, hacemos una llamada AJAX para cargar los nuevos productos
      categoriaSelect.addEventListener('change', function() {
          const categoriaId = this.value;
          if (categoriaId) {
              fetch(`/catalogos/productosPorCategoria/${categoriaId}`)
                  .then(resp => resp.json())
                  .then(data => {
                      // Se renderizan los nuevos productos
                      renderProductos(data);
                  });
          } else {
              productosContainer.innerHTML = '<p class="text-gray-500">Selecciona una categoría para ver los productos.</p>';
          }
      });
  });
</script>

</html>